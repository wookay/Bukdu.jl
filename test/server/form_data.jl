module test_server_form_data

import Bukdu: Plug
import Bukdu.Server: FormScanner, scan
import Base.Test: @test, @test_throws


data = UInt8[0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x44,0x69,0x73,0x70,0x6f,0x73,0x69,0x74,0x69,0x6f,0x6e,0x3a,0x20,0x66,0x6f,0x72,0x6d,0x2d,0x64,0x61,0x74,0x61,0x3b,0x20,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x5f,0x63,0x73,0x72,0x66,0x5f,0x74,0x6f,0x6b,0x65,0x6e,0x22,0x0d,0x0a,0x0d,0x0a,0x63,0x73,0x72,0x66,0x2d,0x35,0x39,0x37,0x34,0x65,0x33,0x62,0x38,0x2d,0x38,0x65,0x62,0x35,0x2d,0x31,0x31,0x65,0x36,0x2d,0x32,0x35,0x63,0x34,0x2d,0x30,0x37,0x36,0x64,0x64,0x31,0x61,0x37,0x63,0x63,0x37,0x33,0x0d,0x0a,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x44,0x69,0x73,0x70,0x6f,0x73,0x69,0x74,0x69,0x6f,0x6e,0x3a,0x20,0x66,0x6f,0x72,0x6d,0x2d,0x64,0x61,0x74,0x61,0x3b,0x20,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x75,0x73,0x65,0x72,0x5f,0x6e,0x61,0x6d,0x65,0x22,0x0d,0x0a,0x0d,0x0a,0x66,0x6f,0x6f,0x20,0x62,0x61,0x72,0x0d,0x0a,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x44,0x69,0x73,0x70,0x6f,0x73,0x69,0x74,0x69,0x6f,0x6e,0x3a,0x20,0x66,0x6f,0x72,0x6d,0x2d,0x64,0x61,0x74,0x61,0x3b,0x20,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x75,0x73,0x65,0x72,0x5f,0x61,0x67,0x65,0x22,0x0d,0x0a,0x0d,0x0a,0x32,0x30,0x0d,0x0a,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x44,0x69,0x73,0x70,0x6f,0x73,0x69,0x74,0x69,0x6f,0x6e,0x3a,0x20,0x66,0x6f,0x72,0x6d,0x2d,0x64,0x61,0x74,0x61,0x3b,0x20,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x75,0x73,0x65,0x72,0x5f,0x68,0x61,0x70,0x70,0x69,0x6e,0x65,0x73,0x73,0x22,0x0d,0x0a,0x0d,0x0a,0x30,0x2e,0x35,0x0d,0x0a,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x44,0x69,0x73,0x70,0x6f,0x73,0x69,0x74,0x69,0x6f,0x6e,0x3a,0x20,0x66,0x6f,0x72,0x6d,0x2d,0x64,0x61,0x74,0x61,0x3b,0x20,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x75,0x73,0x65,0x72,0x5f,0x6c,0x75,0x6e,0x63,0x68,0x22,0x0d,0x0a,0x0d,0x0a,0x63,0x68,0x69,0x63,0x6b,0x65,0x6e,0x0d,0x0a,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x44,0x69,0x73,0x70,0x6f,0x73,0x69,0x74,0x69,0x6f,0x6e,0x3a,0x20,0x66,0x6f,0x72,0x6d,0x2d,0x64,0x61,0x74,0x61,0x3b,0x20,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x75,0x73,0x65,0x72,0x5f,0x64,0x65,0x73,0x63,0x72,0x69,0x70,0x74,0x69,0x6f,0x6e,0x22,0x0d,0x0a,0x0d,0x0a,0x0d,0x0a,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x44,0x69,0x73,0x70,0x6f,0x73,0x69,0x74,0x69,0x6f,0x6e,0x3a,0x20,0x66,0x6f,0x72,0x6d,0x2d,0x64,0x61,0x74,0x61,0x3b,0x20,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x75,0x73,0x65,0x72,0x5f,0x61,0x74,0x74,0x61,0x63,0x68,0x22,0x3b,0x20,0x66,0x69,0x6c,0x65,0x6e,0x61,0x6d,0x65,0x3d,0x22,0x6f,0x6e,0x65,0x2e,0x70,0x6e,0x67,0x22,0x0d,0x0a,0x43,0x6f,0x6e,0x74,0x65,0x6e,0x74,0x2d,0x54,0x79,0x70,0x65,0x3a,0x20,0x69,0x6d,0x61,0x67,0x65,0x2f,0x70,0x6e,0x67,0x0d,0x0a,0x0d,0x0a,0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x02,0x08,0x06,0x00,0x00,0x00,0x9d,0x74,0x66,0x1a,0x00,0x00,0x00,0x01,0x73,0x52,0x47,0x42,0x00,0xae,0xce,0x1c,0xe9,0x00,0x00,0x00,0x14,0x49,0x44,0x41,0x54,0x08,0x1d,0x63,0x64,0xf8,0x9f,0xf5,0x9f,0x01,0x0a,0x98,0x60,0x0c,0x10,0x0d,0x00,0x37,0xa6,0x02,0x6c,0xda,0xad,0xb5,0xb5,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,0x82,0x0d,0x0a,0x2d,0x2d,0x2d,0x2d,0x2d,0x2d,0x57,0x65,0x62,0x4b,0x69,0x74,0x46,0x6f,0x72,0x6d,0x42,0x6f,0x75,0x6e,0x64,0x61,0x72,0x79,0x42,0x79,0x65,0x52,0x70,0x76,0x54,0x68,0x31,0x69,0x62,0x31,0x67,0x36,0x70,0x4b,0x2d,0x2d,0x0d,0x0a]
boundary = "------WebKitFormBoundaryByeRpvTh1ib1g6pK"
scanner = FormScanner(data, boundary)

assoc = scan(scanner)
@test "foo bar" == assoc[:user_name]
@test "20" == assoc[:user_age]
@test "0.5" == assoc[:user_happiness]
@test "" == assoc[:user_description]
file = assoc[:user_attach]
@test isa(file, Plug.Upload)
@test "one.png" == file.filename
@test "image/png" == file.content_type
@test 90 == length(file.data)
@test UInt8[0x89,0x50,0x4e,0x47,0x0d,0x0a] == file.data[1:6]


s = """------WebKitFormBoundaryxGRqw9fgYsiNDR28
Content-Disposition: form-data; name="user_name"

foo bar
------WebKitFormBoundaryxGRqw9fgYsiNDR28
Content-Disposition: form-data; name="user_age"

20
------WebKitFormBoundaryxGRqw9fgYsiNDR28
Content-Disposition: form-data; name="user_happiness"

0.5
------WebKitFormBoundaryxGRqw9fgYsiNDR28
Content-Disposition: form-data; name="user_description"


------WebKitFormBoundaryxGRqw9fgYsiNDR28
Content-Disposition: form-data; name="user_attach"; filename="foo.txt"
Content-Type: text/plain

bar
baz

------WebKitFormBoundaryxGRqw9fgYsiNDR28--"""
boundary = "------WebKitFormBoundaryxGRqw9fgYsiNDR28"
scanner = FormScanner(Vector{UInt8}(s), boundary)
assoc = scan(scanner)
@test "foo bar" == assoc[:user_name]
@test "20" == assoc[:user_age]
@test "0.5" == assoc[:user_happiness]
@test "" == assoc[:user_description]
file = assoc[:user_attach]
@test isa(file, Plug.Upload)
@test "foo.txt" == file.filename
@test "text/plain" == file.content_type
@test "bar\nbaz\n" == String(file.data)

end # module test_server_form_data
